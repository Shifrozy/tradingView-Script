//@version=5
indicator("Bullish Divergence Breakout Pro", overlay=true, max_labels_count=500, max_lines_count=500)

// === Inputs ===
useRSI       = input.bool(false, "Use RSI instead of MACD?")
rsiLen       = input.int(14, "RSI Length", minval=2)
fastLen      = input.int(12, "MACD Fast Length", minval=1)
slowLen      = input.int(26, "MACD Slow Length", minval=1)
sigLen       = input.int(9, "MACD Signal Length", minval=1)
pivotLen     = input.int(5, "Pivot Lookback Strength", minval=1)

chanLen      = input.int(20, "Background Channel Length", minval=2)
chanMult     = input.float(2.0, "Channel Mult", minval=0.1)

stopOffset   = input.float(0.0, "Stop-Loss Offset (%)", minval=0.0, tooltip="Extra room below swing low")

showTrend    = input.bool(true, "Show Descending Trendline")
showDiv      = input.bool(true, "Show Divergence Labels")
showStops    = input.bool(true, "Show Stop-Loss Line")
showChannel  = input.bool(true, "Show Blue Background Channel")
showMACD     = input.bool(true, "Show MACD Panel")

// === Oscillators ===
macdLine = ta.ema(close, fastLen) - ta.ema(close, slowLen)
signal   = ta.ema(macdLine, sigLen)
hist     = macdLine - signal
rsi      = ta.rsi(close, rsiLen)
osc      = useRSI ? rsi : hist

// === Channel Background ===
basis = ta.sma(close, chanLen)
dev   = ta.stdev(close, chanLen) * chanMult
upper = basis + dev
lower = basis - dev
if showChannel
    bgcolor(color.new(color.blue, 90), title="Background", transp=85)

// === Pivots ===
pHigh = ta.pivothigh(high, pivotLen, pivotLen)
pLow  = ta.pivotlow(low, pivotLen, pivotLen)
oHigh = ta.pivothigh(osc, pivotLen, pivotLen)
oLow  = ta.pivotlow(osc, pivotLen, pivotLen)

// === Bearish Trendline (descending highs) ===
var line trendLine = na
trendBreak = false
if showTrend and not na(pHigh)
    if na(trendLine)
        trendLine := line.new(bar_index - pivotLen, high[pivotLen], bar_index - pivotLen, high[pivotLen], color=color.black, style=line.style_dotted)
    else
        line.delete(trendLine)
        trendLine := line.new(bar_index[pivotLen*2], high[pivotLen*2], bar_index - pivotLen, high[pivotLen], color=color.black, style=line.style_dotted)
if showTrend and not na(trendLine)
    trendBreak := close > line.get_price(trendLine, bar_index)

// === Bullish Divergence Detection ===
bullDiv = (not na(pLow) and not na(oLow) and low[pivotLen] < low[pivotLen*2] and osc[pivotLen] > osc[pivotLen*2])
if showDiv and bullDiv
    label.new(bar_index - pivotLen, low[pivotLen], "Diver ðŸŸ¢", style=label.style_label_up, color=color.green, textcolor=color.white)
    label.new(bar_index - pivotLen, osc[pivotLen], "Diver ðŸŸ¢", yloc=yloc.indicator, color=color.green, style=label.style_label_up, textcolor=color.white)

// === Entry Condition ===
longEntry = bullDiv and trendBreak
if longEntry
    label.new(bar_index, close, "ðŸŸ¢ Buy Entry", style=label.style_label_up, color=color.green, textcolor=color.white)

// === Stop Loss ===
var float stopLevel = na
if longEntry
    stopLevel := low[pivotLen] * (1 - stopOffset/100.0)
if showStops and not na(stopLevel)
    line.new(bar_index, stopLevel, bar_index+5, stopLevel, style=line.style_dashed, color=color.red, extend=extend.right)
    label.new(bar_index, stopLevel, "â›” Stop Loss Here", style=label.style_label_down, color=color.red, textcolor=color.white)

// === Alerts ===
if longEntry
    alert("ðŸŸ¢ Buy Signal! Stop Loss: " + str.tostring(stopLevel, format.mintick), alert.freq_once_per_bar_close)

// === Optional MACD panel ===
if showMACD
    macdplot     = plot(macdLine, color=color.blue, title="MACD Line", display=display.none)
    signalplot   = plot(signal,   color=color.orange, title="Signal Line", display=display.none)
    histplot     = plot(hist, style=plot.style_columns, title="Histogram", color= hist >= 0 ? color.green : color.red, display=display.none)
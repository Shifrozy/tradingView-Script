//@version=6
indicator("Professional Trendline Breakout Indicator", overlay=true, max_lines_count=500, max_labels_count=500)

// ==================== USER INPUTS ====================
// Pivot Detection Settings
pivotLength = input.int(5, "Pivot Length", minval=3, group="Trendline Settings", 
     tooltip="Number of bars to identify swing highs/lows")

// Trade Management Settings
profitTargetPercent = input.float(10.0, "Profit Target %", minval=0.1, step=0.1, group="Trade Management",
     tooltip="Percentage above/below entry for take profit")
stopLookback = input.int(5, "Stop Loss Lookback", minval=1, group="Trade Management",
     tooltip="Number of bars to look back for stop loss calculation")

// Visual Settings
showTrendlines = input.bool(true, "Show Trendlines", group="Visual Settings")
showEntrySignals = input.bool(true, "Show Entry Signals", group="Visual Settings")
showSLTP = input.bool(true, "Show Stop Loss & Take Profit", group="Visual Settings")
showBackground = input.bool(false, "Highlight Breakout Bars", group="Visual Settings")
showLabels = input.bool(true, "Show Price Labels", group="Visual Settings")

// Colors
resistanceColor = input.color(color.gray, "Resistance Line Color", group="Colors")
supportColor = input.color(color.gray, "Support Line Color", group="Colors")
buyColor = input.color(color.new(color.green, 0), "Buy Signal Color", group="Colors")
sellColor = input.color(color.new(color.red, 0), "Sell Signal Color", group="Colors")

// ==================== PIVOT DETECTION ====================
// Function to detect pivot highs
pivotHigh = ta.pivothigh(high, pivotLength, pivotLength)
pivotLow = ta.pivotlow(low, pivotLength, pivotLength)

// Arrays to store pivot points
var array<float> resistancePivots = array.new<float>()
var array<int> resistanceBars = array.new<int>()
var array<float> supportPivots = array.new<float>()
var array<int> supportBars = array.new<int>()

// Store new pivots
if not na(pivotHigh)
    array.push(resistancePivots, pivotHigh)
    array.push(resistanceBars, bar_index - pivotLength)
    // Keep only last 50 pivots for performance
    if array.size(resistancePivots) > 50
        array.shift(resistancePivots)
        array.shift(resistanceBars)

if not na(pivotLow)
    array.push(supportPivots, pivotLow)
    array.push(supportBars, bar_index - pivotLength)
    // Keep only last 50 pivots for performance
    if array.size(supportPivots) > 50
        array.shift(supportPivots)
        array.shift(supportBars)

// ==================== TRENDLINE CALCULATION ====================
// Function to calculate trendline slope and intercept
calculateTrendline(pivots, bars) =>
    size = array.size(pivots)
    if size < 2
        [0.0, 0.0]
    else
        // Get last two pivots for simple trendline
        y2 = array.get(pivots, size - 1)
        y1 = array.get(pivots, size - 2)
        x2 = array.get(bars, size - 1)
        x1 = array.get(bars, size - 2)
        
        slope = (y2 - y1) / (x2 - x1)
        intercept = y1 - slope * x1
        [slope, intercept]

// Calculate current trendline values
[resistanceSlope, resistanceIntercept] = calculateTrendline(resistancePivots, resistanceBars)
[supportSlope, supportIntercept] = calculateTrendline(supportPivots, supportBars)

// Current trendline values at current bar
resistanceValue = resistanceIntercept + resistanceSlope * bar_index
supportValue = supportIntercept + supportSlope * bar_index

// ==================== BREAKOUT DETECTION ====================
// Breakout conditions
resistanceBreakout = close > resistanceValue and close[1] <= resistanceValue[1] and array.size(resistancePivots) >= 2
supportBreakout = close < supportValue and close[1] >= supportValue[1] and array.size(supportPivots) >= 2

// ==================== TRADE MANAGEMENT ====================
// Calculate stop loss levels
buyStopLoss = ta.lowest(low, stopLookback)
sellStopLoss = ta.highest(high, stopLookback)

// Calculate take profit levels
buyTakeProfit = close * (1 + profitTargetPercent / 100)
sellTakeProfit = close * (1 - profitTargetPercent / 100)

// ==================== VISUAL ELEMENTS ====================
// Draw trendlines (dotted style)
var line resistanceLine = na
var line supportLine = na

if showTrendlines and array.size(resistancePivots) >= 2
    if not na(resistanceLine)
        line.delete(resistanceLine)
    x1 = array.get(resistanceBars, array.size(resistanceBars) - 2)
    y1 = array.get(resistancePivots, array.size(resistancePivots) - 2)
    resistanceLine := line.new(x1, y1, bar_index + 50, resistanceValue + resistanceSlope * 50, 
         color=resistanceColor, width=1, style=line.style_dotted, extend=extend.right)

if showTrendlines and array.size(supportPivots) >= 2
    if not na(supportLine)
        line.delete(supportLine)
    x1 = array.get(supportBars, array.size(supportBars) - 2)
    y1 = array.get(supportPivots, array.size(supportPivots) - 2)
    supportLine := line.new(x1, y1, bar_index + 50, supportValue + supportSlope * 50, 
         color=supportColor, width=1, style=line.style_dotted, extend=extend.right)

// Entry signals with professional labels
if showEntrySignals
    if resistanceBreakout
        // Buy signal with detailed label
        buyLabel = label.new(bar_index, low * 0.995, 
             text="BUY SIGNAL\nEntry: " + str.tostring(close, "#,###.##") + 
             "\nTarget: " + str.tostring(buyTakeProfit, "#,###.##") + 
             "\nStop: " + str.tostring(buyStopLoss, "#,###.##"),
             color=buyColor, 
             style=label.style_label_up, 
             size=size.normal, 
             textcolor=color.white,
             textalign=text.align_center)
             
    if supportBreakout
        // Sell signal with detailed label
        sellLabel = label.new(bar_index, high * 1.005, 
             text="SELL SIGNAL\nEntry: " + str.tostring(close, "#,###.##") + 
             "\nTarget: " + str.tostring(sellTakeProfit, "#,###.##") + 
             "\nStop: " + str.tostring(sellStopLoss, "#,###.##"),
             color=sellColor, 
             style=label.style_label_down, 
             size=size.normal, 
             textcolor=color.white,
             textalign=text.align_center)

// Stop loss and take profit lines with clear labels
if showSLTP
    if resistanceBreakout
        // Stop loss line
        slLine = line.new(bar_index, buyStopLoss, bar_index + 30, buyStopLoss, 
             color=color.new(color.red, 30), style=line.style_dashed, width=2)
        // Take profit line
        tpLine = line.new(bar_index, buyTakeProfit, bar_index + 30, buyTakeProfit, 
             color=color.new(color.green, 30), style=line.style_dashed, width=2)
        
        if showLabels
            // Professional stop loss label
            label.new(bar_index + 30, buyStopLoss, 
                 text="STOP LOSS\n" + str.tostring(buyStopLoss, "#,###.##"), 
                 color=color.new(color.red, 20), 
                 style=label.style_label_left, 
                 textcolor=color.white, 
                 size=size.small,
                 textalign=text.align_center)
            // Professional take profit label
            label.new(bar_index + 30, buyTakeProfit, 
                 text="TAKE PROFIT\n" + str.tostring(buyTakeProfit, "#,###.##") + 
                 "\n(+" + str.tostring(profitTargetPercent, "#.#") + "%)", 
                 color=color.new(color.green, 20), 
                 style=label.style_label_left, 
                 textcolor=color.white, 
                 size=size.small,
                 textalign=text.align_center)
    
    if supportBreakout
        // Stop loss line
        slLine = line.new(bar_index, sellStopLoss, bar_index + 30, sellStopLoss, 
             color=color.new(color.red, 30), style=line.style_dashed, width=2)
        // Take profit line
        tpLine = line.new(bar_index, sellTakeProfit, bar_index + 30, sellTakeProfit, 
             color=color.new(color.green, 30), style=line.style_dashed, width=2)
        
        if showLabels
            // Professional stop loss label
            label.new(bar_index + 30, sellStopLoss, 
                 text="STOP LOSS\n" + str.tostring(sellStopLoss, "#,###.##"), 
                 color=color.new(color.red, 20), 
                 style=label.style_label_left, 
                 textcolor=color.white, 
                 size=size.small,
                 textalign=text.align_center)
            // Professional take profit label
            label.new(bar_index + 30, sellTakeProfit, 
                 text="TAKE PROFIT\n" + str.tostring(sellTakeProfit, "#,###.##") + 
                 "\n(-" + str.tostring(profitTargetPercent, "#.#") + "%)", 
                 color=color.new(color.green, 20), 
                 style=label.style_label_left, 
                 textcolor=color.white, 
                 size=size.small,
                 textalign=text.align_center)

// Background highlighting (subtle)
bgcolor(showBackground and resistanceBreakout ? color.new(buyColor, 95) : na)
bgcolor(showBackground and supportBreakout ? color.new(sellColor, 95) : na)

// ==================== INFORMATION PANEL ====================
// Display current trendline info in status line
var table infoTable = table.new(position.top_right, 2, 3, bgcolor=color.new(color.black, 80))

if barstate.islast and showLabels
    table.cell(infoTable, 0, 0, "TRENDLINE STATUS", text_color=color.white, text_size=size.small)
    table.cell(infoTable, 0, 1, "Resistance:", text_color=color.orange, text_size=size.small)
    table.cell(infoTable, 1, 1, str.tostring(resistanceValue, "#,###.##"), text_color=color.white, text_size=size.small)
    table.cell(infoTable, 0, 2, "Support:", text_color=color.blue, text_size=size.small)
    table.cell(infoTable, 1, 2, str.tostring(supportValue, "#,###.##"), text_color=color.white, text_size=size.small)

// ==================== PLOTS FOR ALERTS ====================
// Plot values for use in alerts (invisible on chart)
plot(resistanceBreakout ? buyStopLoss : na, title="Buy Stop Loss", display=display.none)
plot(resistanceBreakout ? buyTakeProfit : na, title="Buy Take Profit", display=display.none)
plot(supportBreakout ? sellStopLoss : na, title="Sell Stop Loss", display=display.none)
plot(supportBreakout ? sellTakeProfit : na, title="Sell Take Profit", display=display.none)
plot(close, title="Entry Price", display=display.none)

// ==================== ALERTS ====================
// Alert conditions with clear messages
alertcondition(resistanceBreakout, 
     title="ðŸŸ¢ BUY Signal - Resistance Breakout", 
     message="BUY SIGNAL TRIGGERED! Resistance line broken. Check chart for entry and exit levels.")

alertcondition(supportBreakout, 
     title="ðŸ”´ SELL Signal - Support Breakout", 
     message="SELL SIGNAL TRIGGERED! Support line broken. Check chart for entry and exit levels.")

alertcondition(resistanceBreakout or supportBreakout, 
     title="âš¡ Any Breakout Alert", 
     message="BREAKOUT DETECTED! New trading opportunity. Review chart for signal details.")

// Webhook alerts with JSON format
alertcondition(resistanceBreakout, 
     title="ðŸ“Š BUY Webhook Signal", 
     message='{"signal": "BUY", "symbol": "{{ticker}}", "entry": "{{close}}", "timestamp": "{{time}}"}')

alertcondition(supportBreakout, 
     title="ðŸ“Š SELL Webhook Signal", 
     message='{"signal": "SELL", "symbol": "{{ticker}}", "entry": "{{close}}", "timestamp": "{{time}}"}')
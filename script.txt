//@version=5
indicator("Bullish Divergence Breakout Pro [Polished Compact]", overlay=true, max_labels_count=1000, max_lines_count=500)
useRSI=input.bool(false,"Use RSI instead of MACD?") 
rsiLen=input.int(14,"RSI Length",minval=2) 
fastLen=input.int(12,"MACD Fast Length",minval=1) 
slowLen=input.int(26,"MACD Slow Length",minval=1) 
sigLen=input.int(9,"MACD Signal Length",minval=1) 
pivotLen=input.int(5,"Pivot Strength",minval=1) 
stopOffset=input.float(0.5,"Stop-Loss Offset %",minval=0.0) 
showTrend=input.bool(true,"Show Descending Trendline") 
showDiv=input.bool(true,"Show Divergence Labels") 
showStops=input.bool(true,"Show Stop-Loss Levels") 
showMACD=input.bool(true,"Show MACD Panel") 
macdLine=ta.ema(close,fastLen)-ta.ema(close,slowLen) 
signal=ta.ema(macdLine,sigLen) 
hist=macdLine-signal 
rsi=ta.rsi(close,rsiLen) 
osc=useRSI?rsi:hist 
pHigh=ta.pivothigh(high,pivotLen,pivotLen) 
pLow=ta.pivotlow(low,pivotLen,pivotLen) 
oLow=ta.pivotlow(osc,pivotLen,pivotLen) 
var line trendLine=na 
trendBreak=false 
if showTrend and not na(pHigh) 
    if na(trendLine) 
        trendLine:=line.new(bar_index-pivotLen,high[pivotLen],bar_index-pivotLen,high[pivotLen],color=color.black,style=line.style_dotted,width=2,extend=extend.right) 
    else 
        line.delete(trendLine) 
        trendLine:=line.new(bar_index[pivotLen*2],high[pivotLen*2],bar_index-pivotLen,high[pivotLen],color=color.black,style=line.style_dotted,width=2,extend=extend.right) 
if showTrend and not na(trendLine) 
    trendBreak:=close>line.get_price(trendLine,bar_index) 
bullDiv=(not na(pLow) and not na(oLow) and low[pivotLen]<low[pivotLen*2] and osc[pivotLen]>osc[pivotLen*2]) 
if showDiv and bullDiv 
    label.new(bar_index-pivotLen,low[pivotLen],"Bull Div ðŸŸ¢",style=label.style_label_up,color=color.green,textcolor=color.white) 
longEntry=bullDiv and trendBreak 
var float stopLevel=na 
if longEntry 
    label.new(bar_index,close,"ðŸŸ¢ Buy Entry",style=label.style_label_up,color=color.green,textcolor=color.white) 
    stopLevel:=low[pivotLen]*(1-stopOffset/100) 
    if showStops 
        line.new(bar_index,stopLevel,bar_index+10,stopLevel,style=line.style_dashed,color=color.red,width=2,extend=extend.right) 
        label.new(bar_index,stopLevel,"â›” Stop Loss",style=label.style_label_down,color=color.red,textcolor=color.white) 
if longEntry 
    alert("ðŸŸ¢ Buy Signal! Stop Loss: "+str.tostring(stopLevel,format.mintick),alert.freq_once_per_bar_close) 
plot(macdLine,title="MACD Line",color=color.blue,display=showMACD?display.all:display.none) 
plot(signal,title="Signal Line",color=color.orange,display=showMACD?display.all:display.none) 
plot(hist,title="Histogram",style=plot.style_columns,color=hist>=0?color.green:color.red,display=showMACD?display.all:display.none)